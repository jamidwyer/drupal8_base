<?xml version="1.0" encoding="UTF-8"?>

<project name="perofil_ecommerce" default="dummy">
  <property name="console" value="bin/console"/>

  <target name="generate-settings" if="env">
    <chmod file="web/sites/${settings.directory.source}" mode="755" verbose="true" />
    <chmod file="web/sites/${settings.directory.destination}" mode="755" verbose="true" />
    <mkdir dir="web/sites/${settings.directory.source}" />
    <mkdir dir="web/sites/${settings.directory.destination}" />
    <copy file="web/sites/${settings.directory.source}/default.settings.php" tofile="sites/${settings.directory.source}/settings.php" overwrite="true">
      <filterchain>
        <replacetokens begintoken="%%" endtoken="%%">
          <token key="DB_NAME" value="${source.db.name}" />
          <token key="DB_USER_NAME" value="${source.db.user.name}" />
          <token key="DB_USER_PASS" value="${source.db.user.pass}" />
          <token key="DB_HOST" value="${source.db.host}" />
          <token key="DB_PORT" value="${source.db.port}" />
          <token key="SETTINGS_INSTALL_PROFILE" value="${site.profile}" />
        </replacetokens>
      </filterchain>
    </copy>

    <if>
      <available file='web/sites/${settings.directory.destination}' type='dir' />
      <then>
        <echo>Set chmod for default/ folder</echo>
        <chmod file="web/sites/${settings.directory.destination}" mode="755" verbose="true" failonerror="false"/>
      </then>
    </if>
    <copy file="web/sites/${settings.directory.source}/default.settings.php" tofile="web/sites/${settings.directory.destination}/settings.php" overwrite="true">
      <filterchain>
        <replacetokens begintoken="%%" endtoken="%%">
          <token key="DB_NAME" value="${source.db.name}" />
          <token key="DB_USER_NAME" value="${source.db.user.name}" />
          <token key="DB_USER_PASS" value="${source.db.user.pass}" />
          <token key="DB_HOST" value="${source.db.host}" />
          <token key="DB_PORT" value="${source.db.port}" />
          <token key="SETTINGS_INSTALL_PROFILE" value="${site.profile}" />
        </replacetokens>
      </filterchain>
    </copy>
  </target>

  <target name="generate-sites" if="env">
    <echo>Delete settings.php and sites.php files </echo>
    <delete file="web/sites/sites.php" failonerror="false" />
    <copy file="web/sites/example.sites.php" tofile="web/sites/sites.php" overwrite="true">
      <filterchain>
        <replacetokens begintoken="%%" endtoken="%%">
          <token key="SITES_DOMAIN" value="${domain}" />
          <!-- INVESTIGATE -->
          <token key="SITES_DESTINATION" value="${settings.directory.destination}" />
        </replacetokens>
      </filterchain>
    </copy>
  </target>

  <target name="reset-dir-permissions" if="env">
    <chmod file="web/sites/${settings.directory.source}" mode="755" verbose="true" failonerror="false"/>
    <chmod file="web/sites/${settings.directory.destination}" mode="755" verbose="true" failonerror="false"/>
  </target>

  <target name="generate-properties" if="env">
    <if>
      <available file='build.${env}.properties' type='file' />
      <then>
        <echo>Properties available. skip generation</echo>
      </then>
      <else>
        <echo>Generate file properties</echo>
        <copy file="build.properties.dist" tofile="build.${env}.properties">
          <filterchain>
            <replacetokens begintoken="%%" endtoken="%%">
              <token key="ENV" value="${env}" />
            </replacetokens>
          </filterchain>
        </copy>
      </else>
    </if>
  </target>

  <target name="get-properties" if="env">
    <property file="build.${env}.properties" />
  </target>

  <target name="build-app" if="env" depends="generate-properties">
    <property file="build.${env}.properties" />
    <phingcall target="generate-settings" />
    <phingcall target="generate-sites" />
  </target>
</project>
